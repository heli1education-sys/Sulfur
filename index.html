import React, { useState } from 'react';
import { station3Data } from '../data';
import { playSound, initAudio } from '../utils/audio';
import { CheckCircle, Eye, CloudSun, Mirror, Sparkles, Heart, Skull, Zap, Star } from './Icons';
import VictoryOverlay from './VictoryOverlay';

interface Station3Props {
    onComplete: () => void;
    onMistake: (msg: string) => void;
    onMirrorOutcome?: (outcome: { type: 'life' | 'score', value: number }) => void;
}

const Station3: React.FC<Station3Props> = ({ onComplete, onMistake, onMirrorOutcome }) => {
    const [idx, setIdx] = useState(0);
    const [showRes, setShowRes] = useState(false);
    const [isCompleted, setIsCompleted] = useState(false);
    const [showRules, setShowRules] = useState(true);
    const [viewState, setViewState] = useState<'question' | 'result' | 'mirror' | 'outcome'>('question');
    const [mirrorResult, setMirrorResult] = useState<{ type: 'life' | 'score', value: number, text: string, icon: any, color: string } | null>(null);

    const handleAns = (val: boolean) => {
        initAudio();
        if (viewState !== 'question') return;
        if (val === station3Data[idx].isTrue) {
            playSound('correct');
            setViewState('result');
        } else {
            playSound('wrong');
            onMistake("C√¢u tr·∫£ l·ªùi ch∆∞a ch√≠nh x√°c!");
        }
    };

    const triggerMirror = () => {
        setViewState('mirror');
    };

    const openMirror = () => {
        initAudio();
        const rand = Math.random();
        let result;
        
        if (rand < 0.25) {
            result = { type: 'life' as const, value: 1, text: "Ch√∫c m·ª´ng! B·∫°n nh·∫≠n ƒë∆∞·ª£c +1 M·∫°ng", icon: Heart, color: "text-red-500" };
            playSound('win');
        } else if (rand < 0.5) {
            result = { type: 'life' as const, value: -1, text: "Chia bu·ªìn! B·∫°n b·ªã tr·ª´ -1 M·∫°ng", icon: Skull, color: "text-gray-600" };
            playSound('wrong');
        } else if (rand < 0.75) {
            result = { type: 'score' as const, value: 50, text: "Tuy·ªát v·ªùi! +50 ƒêi·ªÉm th∆∞·ªüng", icon: Star, color: "text-yellow-500" };
            playSound('correct');
        } else {
            result = { type: 'score' as const, value: -100, text: "√îi kh√¥ng! B·ªã tr·ª´ -100 ƒêi·ªÉm", icon: Zap, color: "text-blue-500" };
            playSound('wrong');
        }

        setMirrorResult(result);
        if (onMirrorOutcome) {
            onMirrorOutcome({ type: result.type, value: result.value });
        }
        setViewState('outcome');
    };

    const nextQuestion = () => {
        if (idx < station3Data.length - 1) {
            setIdx(i => i + 1);
            setViewState('question');
            setMirrorResult(null);
        } else {
            setIsCompleted(true);
        }
    };

    if (showRules) {
        return (
            <div className="bg-purple-50 h-full flex flex-col items-center justify-center p-4 md:p-6 text-center rounded-[1.5rem] md:rounded-[2rem] border-4 border-purple-100 animate-fade-in z-20 absolute inset-0">
                <Eye size={64} className="text-purple-400 mb-2 md:mb-4 animate-pulse shrink-0" />
                <h2 className="text-xl md:text-2xl font-black text-purple-600 mb-2 uppercase">Tr·∫°m 3: ƒê·ªÅn Ti√™n</h2>
                <p className="text-sm font-bold text-purple-400 mb-4 md:mb-6 uppercase tracking-widest">Th·ªùi ti·∫øt: S∆∞∆°ng M√π üå´Ô∏è</p>
                <div className="bg-white p-4 rounded-2xl shadow-sm border-2 border-purple-100 mb-6 md:mb-8 text-left max-w-md w-full">
                    <p className="text-gray-600 mb-2"><b>Lu·∫≠t ch∆°i m·ªõi:</b></p>
                    <ul className="list-disc pl-5 text-sm text-gray-600 space-y-2">
                        <li>Tr·∫£ l·ªùi ƒë√∫ng c√¢u h·ªèi ƒë·ªÉ xua tan s∆∞∆°ng m√π.</li>
                        <li><b>ƒê·∫∂C BI·ªÜT:</b> Sau m·ªói c√¢u ƒë√∫ng, b·∫°n s·∫Ω m·ªü <b>G∆∞∆°ng Th·∫ßn</b>.</li>
                        <li>G∆∞∆°ng c√≥ th·ªÉ cho b·∫°n th√™m m·∫°ng/ƒëi·ªÉm ho·∫∑c l·∫•y ƒëi c·ªßa b·∫°n!</li>
                    </ul>
                </div>
                <button onClick={() => { initAudio(); setShowRules(false); }} className="w-full md:w-auto px-8 py-3 bg-purple-500 text-white rounded-xl font-black shadow-[0_4px_0_#7e22ce] active:shadow-none active:translate-y-[4px] transition-all active:scale-95">ƒê√É HI·ªÇU, GI·∫¢I M√É!</button>
            </div>
        );
    }

    return (
        <div className="bg-purple-50 h-full flex flex-col items-center justify-center p-4 md:p-6 relative overflow-hidden rounded-[1.5rem] md:rounded-[2rem] border-4 border-white shadow-lg">
            {isCompleted && <VictoryOverlay onNext={onComplete} message="Ki·∫øn th·ª©c v·ªØng v√†ng!" />}
            
            <div className="w-full max-w-2xl text-center space-y-4 md:space-y-6 relative z-10 flex flex-col h-full justify-center">
                
                {viewState !== 'mirror' && viewState !== 'outcome' && (
                    <>
                        {/* Question Card */}
                        <div className="bg-white p-6 md:p-8 rounded-2xl md:rounded-3xl border-b-8 border-purple-100 shadow-md transform transition-all hover:scale-[1.01]">
                            <div className="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                                <h3 className="text-purple-400 text-[10px] md:text-sm font-black uppercase tracking-widest">C√¢u h·ªèi {idx + 1}/{station3Data.length}</h3>
                                <div className="flex gap-1">
                                    {station3Data.map((_, i) => (
                                        <div key={i} className={`w-2 h-2 rounded-full ${i < idx ? 'bg-green-400' : i === idx ? 'bg-purple-400 animate-pulse' : 'bg-gray-200'}`}></div>
                                    ))}
                                </div>
                            </div>
                            <p className="text-lg md:text-2xl font-bold text-gray-700 leading-relaxed min-h-[80px] flex items-center justify-center">
                                "{station3Data[idx].statement}"
                            </p>
                        </div>

                        {/* Answer Buttons */}
                        {viewState === 'question' ? (
                            <div className="flex flex-col md:flex-row justify-center gap-3 md:gap-6 w-full">
                                <button onClick={() => handleAns(true)} onTouchStart={initAudio} className="flex-1 md:flex-none py-4 md:px-16 bg-green-500 text-white rounded-2xl font-black text-xl shadow-[0_6px_0_#15803d] active:shadow-none active:translate-y-[6px] transition-all touch-manipulation hover:bg-green-600 active:scale-95">
                                    ƒê√öNG
                                </button>
                                <button onClick={() => handleAns(false)} onTouchStart={initAudio} className="flex-1 md:flex-none py-4 md:px-16 bg-red-500 text-white rounded-2xl font-black text-xl shadow-[0_6px_0_#b91c1c] active:shadow-none active:translate-y-[6px] transition-all touch-manipulation hover:bg-red-600 active:scale-95">
                                    SAI
                                </button>
                            </div>
                        ) : (
                            <div className="bg-green-100 p-4 md:p-6 rounded-2xl text-left shadow-inner border-2 border-green-200 animate-in slide-in-from-bottom-4 w-full">
                                <p className="text-green-700 font-bold mb-2 flex items-center gap-2 text-lg"><CheckCircle size={24}/> Ch√≠nh x√°c!</p>
                                <p className="text-green-800 mb-6 text-sm md:text-lg">{station3Data[idx].explanation}</p>
                                <button onClick={triggerMirror} onTouchStart={initAudio} className="w-full py-4 bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-black text-lg rounded-xl shadow-md active:scale-95 transition-transform touch-manipulation flex items-center justify-center gap-2">
                                    <Sparkles className="animate-spin-slow"/> M·ªû G∆Ø∆†NG TH·∫¶N <Sparkles className="animate-spin-slow"/>
                                </button>
                            </div>
                        )}
                    </>
                )}

                {/* Mirror Interface */}
                {viewState === 'mirror' && (
                     <div className="flex flex-col items-center justify-center animate-in zoom-in duration-300">
                        <h3 className="text-xl font-black text-purple-600 mb-6 uppercase tracking-widest animate-pulse">G∆∞∆°ng Th·∫ßn ƒêang Ch·ªù...</h3>
                        <div className="relative group cursor-pointer" onClick={openMirror}>
                             <div className="absolute inset-0 bg-cyan-400 blur-2xl opacity-40 rounded-full animate-pulse group-hover:opacity-60 transition-opacity"></div>
                             <div className="relative w-48 h-64 md:w-60 md:h-80 bg-gradient-to-b from-sky-200 to-white rounded-[4rem] border-8 border-purple-300 shadow-2xl flex items-center justify-center overflow-hidden">
                                <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dust.png')] opacity-30"></div>
                                <div className="w-full h-full bg-gradient-to-tr from-transparent via-white/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700 animate-drift"></div>
                                <Mirror size={80} className="text-purple-400 opacity-50 group-hover:scale-110 transition-transform duration-500" />
                                <p className="absolute bottom-10 text-purple-500 font-bold text-sm animate-bounce">CH·∫†M ƒê·ªÇ M·ªû</p>
                             </div>
                        </div>
                     </div>
                )}

                {/* Mirror Outcome */}
                {viewState === 'outcome' && mirrorResult && (
                    <div className="flex flex-col items-center justify-center animate-in zoom-in duration-300">
                        <div className="bg-white p-6 md:p-8 rounded-[2rem] shadow-2xl border-4 border-purple-100 max-w-sm w-full text-center">
                            <mirrorResult.icon size={64} className={`mx-auto mb-4 ${mirrorResult.color} animate-bounce drop-shadow-md`} />
                            <h3 className={`text-2xl font-black mb-4 ${mirrorResult.color}`}>{mirrorResult.text}</h3>
                            <button onClick={nextQuestion} onTouchStart={initAudio} className="w-full py-4 bg-gray-800 text-white font-black text-lg rounded-xl shadow-lg active:scale-95 transition-transform">
                                TI·∫æP T·ª§C
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

export default Station3;
